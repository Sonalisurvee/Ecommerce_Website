from django.shortcuts import render,redirect,get_object_or_404
from store.models import Product,SizeVariant
from .models import Coupon,Cartt,CartItems,Payment,Order,OrderItem
from account.models import Address
from django.core.exceptions import ObjectDoesNotExist
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import HttpResponseRedirect,HttpResponse
import razorpay
from django.conf import settings



# -----------------------------------Carts --------------------------------

# this is a private method where our session id is stored
def _cart_id(request):
    cart = request.session.session_key
# if the session is not present then it will create new session
    if not cart:
        cart = request.session.create()
    return cart
 

#this cart id fun is created just assign our cart the session id ,wen log in there session id will be created and every userhas its own unqiue 
# session id so every user will have its own cart so no one can have our cart items ,privacy will be maintained.



def add_cart(request,product_id):
    current_user = request.user
    product = Product.objects.get(id=product_id)

# thus try block is created just to chech wethere cart is ther or not ,once cart is created we are able to add produtc to it
    if current_user.is_authenticated:
        cart,_ = Cartt.objects.get_or_create(cart_id=_cart_id(request))
        is_cart_item_exists = CartItems.objects.filter(products=product, user=current_user).exists()
        if is_cart_item_exists:
            cart_item = CartItems.objects.get(products=product,user=current_user)
            cart_item.quantity+=1 #incrementing the quantity of prodiuct presnet in the cart
        else:
            cart_item = CartItems.objects.create( #if not exist it will create one cart
            carts = cart,
            products=product,
            user = current_user,
            quantity = 1
        )
        cart_item.save()
    
    # If user is not authenticated
    else:

        try:
            
            cart = Cartt.objects.get(cart_id=_cart_id(request))
            # cart_id=_cart_id(request),means it will assign cart id as with the session id or key and if cart does not exsit it will go y-to except condi
            #it will match the cart id with the session id to get the cart,lile if we dint add any product in the cart the cart will be emoty ryt 
            # so we nend to check whether that cart exists or not so we gave try and except here.

        except Cartt.DoesNotExist: #wat if cart does not exist
            cart = Cartt.objects.create( #if not exist it will create one cart
                cart_id=_cart_id(request)
            )
        cart.save()

        # this try block is created to add products in cart

        try:
            cart_item = CartItems.objects.get(products=product,carts=cart)
            cart_item.quantity+=1 #incrementing the quantity of prodiuct presnet in the cart
        except CartItems.DoesNotExist:#if cart does not have any product then create one
            cart_item = CartItems.objects.create(
                products=product,
                quantity=1,#as there is no product in cart quantity will be 1 as it is the first product in cart
                carts=cart
            )
        cart_item.save()
    return redirect('cart')




def remove_cart(request,product_id,cart_item_id):
    product = get_object_or_404(Product,id=product_id)
    try:
        if request.user.is_authenticated:
            cart_item = CartItems.objects.get(products=product,user=request.user,id=cart_item_id)
    
        else:
            cart = Cartt.objects.get(cart_id=_cart_id(request))
            cart_item = CartiCartItemstem.objects.get(products=product,carts=cart,id=cart_item_id)
        if cart_item.quantity > 1:
            cart_item.quantity -= 1
            cart_item.save()
        else:
            cart_item.delete()
    except:
        pass
    return redirect('cart')




def remove_cartitem(request,product_id,cart_item_id):    
    product = get_object_or_404(Product,id=product_id)
    if request.user.is_authenticated:
        cart_item = CartItems.objects.get(products=product,user=request.user,id=cart_item_id)
    else:
        cart = Cartt.objects.get(cart_id=_cart_id(request))
        cart_item = CartItems.objects.get(products=product,carts=cart,id=cart_item_id)
    cart_item.delete()
    return redirect('cart')




def cart(request,cart_items=None):
    
    try:
        print('Loading')
        if request.user.is_authenticated:#fro login users
            cart_items = CartItems.objects.filter(user=request.user,is_paid=False)
        else:#fro not login 
            print("inside esle ")
            cart = Cartt.objects.get(cart_id=_cart_id(request))#it will match the cart id with the session id to get the cart
            cart_items = CartItems.objects.filter(carts=cart,is_active=False)# is_axtive used to indicate whether a user account is active or not.
            print("else will end")
  
    except ObjectDoesNotExist:
        print("Cart item does not exist")
        pass         

    context = {
     
        'cart_items':cart_items,
    
    }    
    return render(request, 'cart/cart.html',context)
















    
@login_required(login_url= 'log_in')
def add_to_cart(request,product_id):
    variant = None
    variation =None
    try:
        variation = request.GET.get('variant')#querystring
        print(variant)
        if variation:
            variation = request.GET.get('variant')#if variant then it will get the variant from the urls
            variant = SizeVariant.objects.get(size_name=variation)

        product = Product.objects.get(id=product_id)
        user = request.user
        
        cart , _ = Cartt.objects.get_or_create(user = user,is_paid = False)#to check wether cart has something if nothing the create it
        
        is_cart_item = CartItems.objects.filter(carts=cart, products=product, size_variant=variant).exists()

        if not is_cart_item:
            cart_item = CartItems.objects.create(carts=cart, products=product, size_variant=variant)
            print(cart_item)
            cart_item.save()
        else:
            cart_item = CartItems.objects.get(carts=cart, products=product, size_variant=variant)
            cart_item.quantity += 1
            cart_item.save()     
    
    except:
        pass
    

    return redirect('cart')


def cart(request):
    cart=None
    cart_items=None
    try:
        cart, _ = Cartt.objects.get_or_create(user=request.user, is_paid = False)
        cart_items = CartItems.objects.filter(carts=cart)
    except Exception as e:
        print(e)

    context ={
        'cart':cart,
        'cart_items':cart_items,
    }
    return render(request, 'cart/cartt.html',context)



def remove_cartt(request,product_id,cart_item_id):
    product = get_object_or_404(Product,id=product_id)
    try:
        cart_item = CartItems.objects.get(products=product,id=cart_item_id)    
        if cart_item.quantity > 1:
            cart_item.quantity -= 1
            cart_item.save()
        else:
            cart_item.delete()
    except:
        pass
    return redirect('cart') 



def remove_cartitems(request,product_id,cart_item_id):    
    product = get_object_or_404(Product,id=product_id)   
    cart_item = CartItems.objects.get(products=product,id=cart_item_id)
    cart_item.delete()
    return redirect('cart')


# ----------------------------------checkout--------------------------------------------


# KEY = 'rzp_test_a0WKFGxNpEjkyL'
# SECRET_KEY = 'k7q1VWdctZVX6sZe9p9FWGpJ'

